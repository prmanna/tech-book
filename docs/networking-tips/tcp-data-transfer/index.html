<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Intro # TCP Connection Establishment Handshake # Sync The initiator that is establishing a connection with a target generates a random sequence number (5,045 for this example) and sends a TCP packet with its sync flag set to 1 and its sequenceNumber set to the just-defined sequence number. Sync/Ack Upon receipt of the TCP Sync packet from the initiator, the target sets its ack number value to the received sequenceNumber + 1 (5,046 in this example)."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="TCP Data Transfer"><meta property="og:description" content="Intro # TCP Connection Establishment Handshake # Sync The initiator that is establishing a connection with a target generates a random sequence number (5,045 for this example) and sends a TCP packet with its sync flag set to 1 and its sequenceNumber set to the just-defined sequence number. Sync/Ack Upon receipt of the TCP Sync packet from the initiator, the target sets its ack number value to the received sequenceNumber + 1 (5,046 in this example)."><meta property="og:type" content="article"><meta property="og:url" content="https://prasenjitmanna.com/tech-book/docs/networking-tips/tcp-data-transfer/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2024-05-09T23:05:27+05:30"><title>TCP Data Transfer | Technical Book</title><link rel=manifest href=/tech-book/manifest.json><link rel=icon href=/tech-book/favicon.png type=image/x-icon><link rel=stylesheet href=/tech-book/book.min.46181bc93375ba932026e753b37c40e6ff8bb16a9ef770c78bcc663e4577b1ba.css integrity="sha256-RhgbyTN1upMgJudTs3xA5v+LsWqe93DHi8xmPkV3sbo=" crossorigin=anonymous><script defer src=/tech-book/flexsearch.min.js></script>
<script defer src=/tech-book/en.search.min.729888ec6e36af4aa5e26eb3b345d429f8d90e8251ca9ba987428b8569e59329.js integrity="sha256-cpiI7G42r0ql4m6zs0XUKfjZDoJRypuph0KLhWnlkyk=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/tech-book/><img src=/tech-book/logo.png alt=Logo><span>Technical Book</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><input type=checkbox id=section-374f93193c235d5a59a63115829f835e class=toggle>
<label for=section-374f93193c235d5a59a63115829f835e class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/algorithms/>Algorithms</a></label><ul><li><input type=checkbox id=section-f6b4293ac79e9f284ef5649e49e3639f class=toggle>
<label for=section-f6b4293ac79e9f284ef5649e49e3639f class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/algorithms/breadth-first-search/>Breadth First Search</a></label></li><li><input type=checkbox id=section-2f77d5839f14fc16598e51884edf9cc7 class=toggle>
<label for=section-2f77d5839f14fc16598e51884edf9cc7 class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/algorithms/depth-first-search/>Depth First Search</a></label></li><li><input type=checkbox id=section-8729b110b30a06da65be45e52f9e3fb7 class=toggle>
<label for=section-8729b110b30a06da65be45e52f9e3fb7 class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/algorithms/easy/>Easy Complexity</a></label></li><li><input type=checkbox id=section-ca21930662bb4a3bb727e300c49e2d9e class=toggle>
<label for=section-ca21930662bb4a3bb727e300c49e2d9e class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/algorithms/priority-queue-and-heap/>Priority Queue and Heap</a></label></li><li><input type=checkbox id=section-099794dc84dde9d1e65baa1aa530d340 class=toggle>
<label for=section-099794dc84dde9d1e65baa1aa530d340 class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/algorithms/two-pointers/>Two Pointers & Sliding Window</a></label></li><li><input type=checkbox id=section-df4c4c540e3dcef48dcd2d00c3965057 class=toggle>
<label for=section-df4c4c540e3dcef48dcd2d00c3965057 class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/algorithms/medium/>Medium Complexity</a></label></li></ul></li><li><input type=checkbox id=section-c0873fdd42e1c17c1e07645e6ab51cc6 class=toggle>
<label for=section-c0873fdd42e1c17c1e07645e6ab51cc6 class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/data-center/>Data Center Tips</a></label><ul><li><input type=checkbox id=section-7de7e0e7a732dcd5af373b8a4695c431 class=toggle>
<label for=section-7de7e0e7a732dcd5af373b8a4695c431 class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/data-center/data-center-ethernet/>Data Center Ethernet</a></label></li><li><input type=checkbox id=section-b410e2827c97ad7292e88e649356e4bb class=toggle>
<label for=section-b410e2827c97ad7292e88e649356e4bb class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/data-center/data-center-technologies/>Data Center Technologies</a></label></li><li><input type=checkbox id=section-5fb5e49b75a1392bd1df5174b0e2401c class=toggle>
<label for=section-5fb5e49b75a1392bd1df5174b0e2401c class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/data-center/data-center-network-virtualization/>Network Virtualization in Cloud Data Centers</a></label></li></ul></li><li><input type=checkbox id=section-7e26b4da67ddfd3aaa6c31b6861a89ab class=toggle>
<label for=section-7e26b4da67ddfd3aaa6c31b6861a89ab class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/manageability/>Manageability</a></label><ul><li><input type=checkbox id=section-207ca266e79d5be472b6432e1fb17bc9 class=toggle>
<label for=section-207ca266e79d5be472b6432e1fb17bc9 class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/manageability/why-grpc-on-http2/>gRPC on HTTP/2</a></label></li></ul></li><li><input type=checkbox id=section-fb52063de722764b4360edb4a8e12aac class=toggle checked>
<label for=section-fb52063de722764b4360edb4a8e12aac class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/networking-tips/>Networking Tips</a></label><ul><li><input type=checkbox id=section-c0c77ea3665f75e8725762e5f6c3df5f class=toggle>
<label for=section-c0c77ea3665f75e8725762e5f6c3df5f class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/networking-tips/ecmp/>ECMP Load Balancing</a></label></li><li><input type=checkbox id=section-dc30cf31b9ee2ab33fa86f292b15cb2b class=toggle>
<label for=section-dc30cf31b9ee2ab33fa86f292b15cb2b class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/networking-tips/ip-fragmentation/>IP Fragmentation - IPv4 & IPv6</a></label></li><li><input type=checkbox id=section-08ea5842f5de2b61898b3331283f5a5d class=toggle>
<label for=section-08ea5842f5de2b61898b3331283f5a5d class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/networking-tips/ip-tos-dscp/>IP Precedence And TOS | DSCP</a></label></li><li><input type=checkbox id=section-3df6ef15c6f2aa5dd3d67f5088d745be class=toggle>
<label for=section-3df6ef15c6f2aa5dd3d67f5088d745be class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/networking-tips/mlag/>Multi Chassis Link Aggregation Basics</a></label></li><li><input type=checkbox id=section-47cc7aa07b55b4be11fe16f855d483d8 class=toggle>
<label for=section-47cc7aa07b55b4be11fe16f855d483d8 class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/networking-tips/qos/>QoS</a></label></li><li><input type=checkbox id=section-9b2532f62af98602d9328253e60fe7f9 class=toggle>
<label for=section-9b2532f62af98602d9328253e60fe7f9 class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/networking-tips/spine-leaf-arch/>Spine-leaf Architecture Basics</a></label></li><li><input type=checkbox id=section-9ff3d0dfa529a2a96fb5ed7225cc4dd8 class=toggle>
<label for=section-9ff3d0dfa529a2a96fb5ed7225cc4dd8 class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/networking-tips/tcp-congestion/>TCP Congestion Control</a></label></li><li><input type=checkbox id=section-51783042312781ff36e7ca917311f94a class=toggle checked>
<label for=section-51783042312781ff36e7ca917311f94a class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/networking-tips/tcp-data-transfer/ class=active>TCP Data Transfer</a></label></li></ul></li><li><input type=checkbox id=section-ea5c43baf485397e13cba9de36dde795 class=toggle>
<label for=section-ea5c43baf485397e13cba9de36dde795 class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/programming-tips/>Programming Tips</a></label><ul><li><input type=checkbox id=section-15ee98aa89ade27055dc2c8d1cc12212 class=toggle>
<label for=section-15ee98aa89ade27055dc2c8d1cc12212 class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/programming-tips/c++/>C++ Tips</a></label></li></ul></li><li><input type=checkbox id=section-e1ca16f5998b918e4e01f395e9c81195 class=toggle>
<label for=section-e1ca16f5998b918e4e01f395e9c81195 class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/systemdesign-tips/>SystemDesign-Tips</a></label><ul><li><input type=checkbox id=section-cd24c01774f2ef0254c419c2af253650 class=toggle>
<label for=section-cd24c01774f2ef0254c419c2af253650 class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/systemdesign-tips/code-deployment-system/>Design A Code-Deployment System</a></label></li><li><input type=checkbox id=section-9c8d84ec532d2a2d7bafc9a630fe088a class=toggle>
<label for=section-9c8d84ec532d2a2d7bafc9a630fe088a class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/systemdesign-tips/stock-broker/>Design A Stock-Broker System</a></label></li><li><input type=checkbox id=section-0f676c3118d30de407a723723e27de91 class=toggle>
<label for=section-0f676c3118d30de407a723723e27de91 class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/systemdesign-tips/design-amazon/>Design Amazon</a></label></li><li><input type=checkbox id=section-de7910a662f896155a583da23f7844c9 class=toggle>
<label for=section-de7910a662f896155a583da23f7844c9 class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/systemdesign-tips/design-slack/>Design Slack</a></label></li><li><input type=checkbox id=section-81d594663dd77ffbd855c8bfc64baf2e class=toggle>
<label for=section-81d594663dd77ffbd855c8bfc64baf2e class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/systemdesign-tips/google-drive/>Google Drive - Design</a></label></li></ul></li></ul><ul><li><a href=/tech-book/posts/>Blog</a></li><li><a href=https://prasenjitmanna.com/tech-book/ target=_blank rel=noopener>Technical Book</a></li><li><a href=https://prasenjitmanna.com/ target=_blank rel=noopener>Prasenjit's blog</a></li><li><a href=https://prasenjitmanna.com/upskills/ target=_blank rel=noopener>Prasenjit's upskills</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/tech-book/svg/menu.svg class=book-icon alt=Menu></label>
<strong>TCP Data Transfer</strong>
<label for=toc-control><img src=/tech-book/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#intro>Intro</a><ul><li><a href=#tcp-connection-establishment-handshake>TCP Connection Establishment Handshake</a></li><li><a href=#tcp-connection-termination-handshake>TCP Connection Termination Handshake</a></li><li><a href=#reliable-data-delivery>Reliable Data Delivery</a><ul><li><a href=#tcp-sequence-number-behavior>TCP Sequence Number Behavior</a></li><li><a href=#tcp-data-reorder>TCP Data Reorder</a></li><li><a href=#missing-data-retransmission>Missing Data Retransmission</a></li><li><a href=#duplicate-data-discard>Duplicate Data Discard</a></li><li><a href=#selective-acknowledge>Selective Acknowledge</a></li></ul></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=intro>Intro
<a class=anchor href=#intro>#</a></h1><h2 id=tcp-connection-establishment-handshake>TCP Connection Establishment Handshake
<a class=anchor href=#tcp-connection-establishment-handshake>#</a></h2><ol><li>Sync
The initiator that is establishing a connection with a target generates a
random sequence number (5,045 for this example) and sends a TCP packet
with its sync flag set to 1 and its sequenceNumber set to the just-defined sequence
number.</li><li>Sync/Ack
Upon receipt of the TCP Sync packet from the initiator, the target sets its ack
number value to the received sequenceNumber + 1 (5,046 in this example). The
target responds by setting its own sequence number to a random value
(17,764 in this example) and sending a TCP packet whose sync and ack flags
are both set to 1 and whose sequenceNumber is set to the just-defined sequence
number value and whose ackNumber is set to the target’s just-set ack number.</li><li>Ack
Upon receipt of the TCP Sync/Ack packet, the initiator sets its ack number to
the received sequenceNumber + 1. The initiator then sends a TCP Ack packet to
the target whose ack flag is set to 1 and whose sequenceNumber and ackNumber
are set to the initiator’s corresponding internal values.
<img src=https://prasenjitmanna.com/tech-book/diagrams/tcp-conn/tcp-3way-handshake.png alt=img|320x271></li></ol><h2 id=tcp-connection-termination-handshake>TCP Connection Termination Handshake
<a class=anchor href=#tcp-connection-termination-handshake>#</a></h2><p>The steps in a four-way TCP connection termination handshake are thus.</p><ol><li>Initiator Finish
One side of the connection (the initiator) sends a TCP packet to its connection
partner whose finish bit is set to 1.</li><li>Target Ack or Finish/Ack
The target of the initial termination message responds by sending a TCP
packet to the initiator whose ack bit is set to 1. This acknowledges that the
initiator-to-target data connection is closed and that the initiator will no
longer send TCP data packets to the target. The target responds by sending
two TCP packets to the initiator: one whose ack bit is set to 1 and one whose
finish bit is set to 1. If the target has no more data to send to the initiator, it
may combine these two TCP packets into a single TCP packet where both ack
and finish are set to 1. If the target does have more data to send, the connection
may remain “half open” until the data transmissions are complete.</li><li>Initiator Ack
Finally the initiator sends a TCP packet whose ack bit is set to 1 to complete
the connection termination process.
<img src=https://prasenjitmanna.com/tech-book/diagrams/tcp-conn/tcp-conn-termination.png alt=img|320x271></li></ol><h2 id=reliable-data-delivery>Reliable Data Delivery
<a class=anchor href=#reliable-data-delivery>#</a></h2><p>For a data connection to be reliable, three types of problems must be detected and
corrected. These are:
* out-of-order data
* missing data
* duplicated data</p><p>TCP’s sequence numbers address all three of these problems.</p><h3 id=tcp-sequence-number-behavior>TCP Sequence Number Behavior
<a class=anchor href=#tcp-sequence-number-behavior>#</a></h3><p>Briefly: The initial sequence number is chosen randomly. As the TCP sender
transmits bytes to the receiver, each TCP packet includes a sequenceNumber value
that indicates the cumulative sequence number of the last byte of each packet. The
TCP receiver responds by transmitting TCP Ack packets whose ackNumber value
identifies the highest-numbered byte received without any gaps from the first byte
of the TCP session. Sequence numbers roll over through zero upon exceeding the
maximum value that a 32-bit number can hold.</p><h3 id=tcp-data-reorder>TCP Data Reorder
<a class=anchor href=#tcp-data-reorder>#</a></h3><p>You can see the presence of sequenceNumber in each packet means that a TCP
receiver can position each received packet within a TCP reorder buffer where
the original sequence of data bytes may be reassembled. Let’s consider a simple
scenario where the initial sequence number is 0. If the first packet received by the
TCP receiver has a sequenceNumber value of 1,000 and the packet has a TCP data
payload of 1,000 bytes, then this packet neatly fits within the buffer at offset 0.
The next packet received by the TCP receiver has a sequenceNumber value of 3,000
and carries 1,000 bytes of TCP data. The receiver subtracts the data byte count
from the received sequenceNumber value to arrive at a sequence number of 2,000
for this packet’s first data byte. Thus, the data is written to the buffer starting at
offset 2,000, leaving a 1,000-byte gap between the first and second received packets.
Finally, a TCP packet with 1,000 data bytes and a sequenceNumber of 2,000
is received, meaning the sequence number of the first byte of this packet is 1,000.
This third packet’s data is written into the 1,000-byte gap between the first two
packets’ data, completing the in-order data transfer.
<img src=https://prasenjitmanna.com/tech-book/diagrams/tcp-conn/tcp-data-reorder.png alt=img|320x271></p><h3 id=missing-data-retransmission>Missing Data Retransmission
<a class=anchor href=#missing-data-retransmission>#</a></h3><p>Using the data reordering example from above as a starting point, let’s assume that
the TCP packet whose sequenceNumber value is 2,000 wasn’t simply delivered out
of order, but was lost due to any of a variety of the usual things that happen on
networks. From the TCP receiver’s perspective, the order in which the TCP data packets are received and its responses to the data packets are the same regardless
of whether a packet was lost in transmission (and later retransmitted) or simply
delivered out of order by the network.
In response to the receipt of the first TCP data packet, the TCP receiver transmits
a TCP Ack packet back to the sender with an ackNumber value of 1,000, indicating
that is has successfully received bytes 0 through 999. The second TCP data packet
received by the TCP receiver indicates that a gap exists from byte 1,000 through
1,999. To inform the TCP sender of this, the TCP receiver transmits another TCP
Ack packet with the exact same ackNumber value of 1,000. This informs the TCP
sender that, while the first 1,000 bytes have been successfully received, the next
packet (and possibly more) is currently missing. This duplicate acknowledge (the
sender has already received an acknowledge for the first 1,000 bytes) motivates
the sender to retransmit the first unacknowledged packet (i.e., the packet whose
sequenceNumber is 2,000).
The TCP sender, in turn, keeps track of the TCP Ack messages that have been received
and maintains an awareness of the highest-numbered data byte that’s been
successfully transmitted. Every unacknowledged byte is subject to retransmission.
Re-transmissions and acknowledges may also get lost. Hence, TCP maintains timers
to detect these cases and automatically retransmit either data or Ack packets as
necessary to keep the process moving along.</p><p><img src=https://prasenjitmanna.com/tech-book/diagrams/tcp-conn/tcp-missing-data-behavior.png alt=img|320x271></p><h3 id=duplicate-data-discard>Duplicate Data Discard
<a class=anchor href=#duplicate-data-discard>#</a></h3><p>Duplicate data may be received by a TCP receiver if a packet that is assumed missing
is simply delayed and delivered out of order. The TCP receiver may request another
copy of the packet through the use of a TCP Ack message before the delayed
data packet is received. If both copies of the data packet are eventually successfully
received, then the receiver must deal with redundant data.
If a TCP receiver receives a TCP data packet whose sequenceNumber corresponds
to a data packet that had previously been received (regardless of whether or not it
had been acknowledged), the TCP receiver may either discard the packet or simply
overwrite the data in its receive buffer with the newly received data. Since the data
is the same, the data in the buffer does not change.</p><h3 id=selective-acknowledge>Selective Acknowledge
<a class=anchor href=#selective-acknowledge>#</a></h3><p>If a TCP data packet is lost before arriving at a receiver, but that missing packet
is followed by several successfully received TCP data packets, the receiver has
no effective means for alerting the sender to just retransmit the single missing
packet. Selective acknowledgment (defined by RFC 2018 and known colloquially
as SACK) is an optional extension to TCP that addresses this specific, common
scenario.</p><p><strong>References:</strong></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/prmanna/tech-book/commit/0ae1e9f21c430ac991709e68a95f6ca140f79437 title='Last modified by Prasenjit Manna | May 9, 2024' target=_blank rel=noopener><img src=/tech-book/svg/calendar.svg class=book-icon alt=Calendar>
<span>May 9, 2024</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#intro>Intro</a><ul><li><a href=#tcp-connection-establishment-handshake>TCP Connection Establishment Handshake</a></li><li><a href=#tcp-connection-termination-handshake>TCP Connection Termination Handshake</a></li><li><a href=#reliable-data-delivery>Reliable Data Delivery</a><ul><li><a href=#tcp-sequence-number-behavior>TCP Sequence Number Behavior</a></li><li><a href=#tcp-data-reorder>TCP Data Reorder</a></li><li><a href=#missing-data-retransmission>Missing Data Retransmission</a></li><li><a href=#duplicate-data-discard>Duplicate Data Discard</a></li><li><a href=#selective-acknowledge>Selective Acknowledge</a></li></ul></li></ul></li></ul></nav></div></aside></main></body></html>