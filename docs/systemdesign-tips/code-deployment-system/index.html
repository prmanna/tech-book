<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  1. Gathering System Requirements
  #

As with any systems design interview question, the first thing that we want to do is to gather system requirements; we need to figure out what system we&rsquo;re building exactly.
From the answers we were given to our clarifying questions (see Prompt Box), we&rsquo;re building a system that involves repeatedly (in the order of thousands of times per day) building and deploying code to hundreds of thousands of machines spread out across 5-10 regions around the world."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://prasenjitmanna.com/tech-book/docs/systemdesign-tips/code-deployment-system/"><meta property="og:site_name" content="Technical Book"><meta property="og:title" content="Design A Code-Deployment System"><meta property="og:description" content=" 1. Gathering System Requirements # As with any systems design interview question, the first thing that we want to do is to gather system requirements; we need to figure out what system we’re building exactly.
From the answers we were given to our clarifying questions (see Prompt Box), we’re building a system that involves repeatedly (in the order of thousands of times per day) building and deploying code to hundreds of thousands of machines spread out across 5-10 regions around the world."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2025-05-08T20:35:56+05:30"><title>Design A Code-Deployment System | Technical Book</title>
<link rel=manifest href=/tech-book/manifest.json><link rel=icon href=/tech-book/favicon.png><link rel=canonical href=https://prasenjitmanna.com/tech-book/docs/systemdesign-tips/code-deployment-system/><link rel=stylesheet href=/tech-book/book.min.a61cdb2979f3c2bece54ef69131fba427dd57d55c232d3bb5fdb62ac41aa8354.css integrity="sha256-phzbKXnzwr7OVO9pEx+6Qn3VfVXCMtO7X9tirEGqg1Q=" crossorigin=anonymous><script defer src=/tech-book/fuse.min.js></script><script defer src=/tech-book/en.search.min.4ef2af0c9fcb01841c4d71a4379729b5be7e750f6c9b1bd314e6667ef8e8128b.js integrity="sha256-TvKvDJ/LAYQcTXGkN5cptb5+dQ9smxvTFOZmfvjoEos=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/tech-book/><img src=/tech-book/logo.png alt=Logo><span>Technical Book</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><input type=checkbox id=section-99f552133860bc21797a47fe73e93434 class=toggle>
<label for=section-99f552133860bc21797a47fe73e93434 class="flex justify-between"><a href=/tech-book/docs/5g/>5G</a></label><ul><li><input type=checkbox id=section-dfc790b73acb0410a0114547cbf5af32 class=toggle>
<label for=section-dfc790b73acb0410a0114547cbf5af32 class="flex justify-between"><a href=/tech-book/docs/5g/5g-intro/>An Overview of 5G Networking</a></label></li></ul></li><li><input type=checkbox id=section-7c4a3b16aeeb5b7194b232c1eef2f4fb class=toggle>
<label for=section-7c4a3b16aeeb5b7194b232c1eef2f4fb class="flex justify-between"><a href=/tech-book/docs/algorithms/>Algorithms</a></label><ul><li><input type=checkbox id=section-8956d82fbe6869140758f7e8679174bc class=toggle>
<label for=section-8956d82fbe6869140758f7e8679174bc class="flex justify-between"><a href=/tech-book/docs/algorithms/breadth-first-search/>Breadth First Search</a></label></li><li><input type=checkbox id=section-5a049cfad1740f3fd30565524385fa57 class=toggle>
<label for=section-5a049cfad1740f3fd30565524385fa57 class="flex justify-between"><a href=/tech-book/docs/algorithms/depth-first-search/>Depth First Search</a></label></li><li><input type=checkbox id=section-ebc049f26d82165be8c6f1f9e504e799 class=toggle>
<label for=section-ebc049f26d82165be8c6f1f9e504e799 class="flex justify-between"><a href=/tech-book/docs/algorithms/easy/>Easy Complexity</a></label></li><li><input type=checkbox id=section-1071946392bd1f431993e950147fa054 class=toggle>
<label for=section-1071946392bd1f431993e950147fa054 class="flex justify-between"><a href=/tech-book/docs/algorithms/priority-queue-and-heap/>Priority Queue and Heap</a></label></li><li><input type=checkbox id=section-08afbeb294c43ca4908c1c89a4be9d0a class=toggle>
<label for=section-08afbeb294c43ca4908c1c89a4be9d0a class="flex justify-between"><a href=/tech-book/docs/algorithms/two-pointers/>Two Pointers & Sliding Window</a></label></li><li><input type=checkbox id=section-ef36c7c4f7e0dec6525068c3c409100c class=toggle>
<label for=section-ef36c7c4f7e0dec6525068c3c409100c class="flex justify-between"><a href=/tech-book/docs/algorithms/medium/>Medium Complexity</a></label></li></ul></li><li><input type=checkbox id=section-8c7c5c4a8382299873178820b1d91be1 class=toggle>
<label for=section-8c7c5c4a8382299873178820b1d91be1 class="flex justify-between"><a href=/tech-book/docs/ai-ml-dc/>Data Center Networking for AI Clusters</a></label><ul><li><input type=checkbox id=section-433ccede4154db01f6c601940d2949e0 class=toggle>
<label for=section-433ccede4154db01f6c601940d2949e0 class="flex justify-between"><a href=/tech-book/docs/ai-ml-dc/1-ai-ml-networking/>AI/ML Networking</a></label></li><li><input type=checkbox id=section-65f71f2455a94ea3d1143666d556b0ed class=toggle>
<label for=section-65f71f2455a94ea3d1143666d556b0ed class="flex justify-between"><a href=/tech-book/docs/ai-ml-dc/2-ai-deep-learning-basics/>Deep Learning Basics | Artificial Neuron</a></label></li><li><input type=checkbox id=section-af7b72510cdccfb9feb048bbf70c6f27 class=toggle>
<label for=section-af7b72510cdccfb9feb048bbf70c6f27 class="flex justify-between"><a href=/tech-book/docs/ai-ml-dc/2-1-large-language-models/>Large Language Models (LLM)</a></label></li><li><input type=checkbox id=section-b3eb6a6d3a1b87cba26dcfbb99658303 class=toggle>
<label for=section-b3eb6a6d3a1b87cba26dcfbb99658303 class="flex justify-between"><a href=/tech-book/docs/ai-ml-dc/2-2-parallelism-strategies-in-deep-learning/>Parallelism Strategies in Deep Learning</a></label></li><li><input type=checkbox id=section-f11d3aa2e337730e1e3345f8530fe134 class=toggle>
<label for=section-f11d3aa2e337730e1e3345f8530fe134 class="flex justify-between"><a href=/tech-book/docs/ai-ml-dc/3-challenges-in-ai-fabric/>Challenges in AI Fabric Design</a></label></li><li><input type=checkbox id=section-e28420ec7507646128f3695b6f9badbb class=toggle>
<label for=section-e28420ec7507646128f3695b6f9badbb class="flex justify-between"><a href=/tech-book/docs/ai-ml-dc/4-congestion-avoidance-in-ai-fabric/>Congestion Avoidance in AI Fabric</a></label></li><li><input type=checkbox id=section-67bb7cbb1dd95e59f8515201219c090f class=toggle>
<label for=section-67bb7cbb1dd95e59f8515201219c090f class="flex justify-between"><a href=/tech-book/docs/ai-ml-dc/5-load-balancing-in-ai-fabric/>Load Balancing in AI Fabric</a></label></li><li><input type=checkbox id=section-5f3e07f6cf7921e5291ff7894e06b19b class=toggle>
<label for=section-5f3e07f6cf7921e5291ff7894e06b19b class="flex justify-between"><a href=/tech-book/docs/ai-ml-dc/6-backend-network-topologies-for-ai-fabric/>Backend Network Topologies for AI Fabrics</a></label></li><li><input type=checkbox id=section-adb8e29f405ea627a0e41d43e94e3453 class=toggle>
<label for=section-adb8e29f405ea627a0e41d43e94e3453 class="flex justify-between"><a href=/tech-book/docs/ai-ml-dc/7-rail-desings-in-gpu-fabric/>Rail Designs in GPU Fabric</a></label></li></ul></li><li><input type=checkbox id=section-3272b2d28b2b247027bf478619ca416f class=toggle>
<label for=section-3272b2d28b2b247027bf478619ca416f class="flex justify-between"><a href=/tech-book/docs/data-center/>Data Center Tips</a></label><ul><li><input type=checkbox id=section-984f932c7aba4f0a1841e8413165c947 class=toggle>
<label for=section-984f932c7aba4f0a1841e8413165c947 class="flex justify-between"><a href=/tech-book/docs/data-center/data-center-ethernet/>Data Center Ethernet</a></label></li><li><input type=checkbox id=section-bc5ac88940153a700e63e3be886c63cc class=toggle>
<label for=section-bc5ac88940153a700e63e3be886c63cc class="flex justify-between"><a href=/tech-book/docs/data-center/data-center-technologies/>Data Center Technologies</a></label></li><li><input type=checkbox id=section-86fde1ddf43700ef8191e11c59a82cf1 class=toggle>
<label for=section-86fde1ddf43700ef8191e11c59a82cf1 class="flex justify-between"><a href=/tech-book/docs/data-center/data-center-network-virtualization/>Network Virtualization in Cloud Data Centers</a></label></li></ul></li><li><input type=checkbox id=section-ddf784688e0c6d5abb681d2c57851559 class=toggle>
<label for=section-ddf784688e0c6d5abb681d2c57851559 class="flex justify-between"><a href=/tech-book/docs/manageability/>Manageability</a></label><ul><li><input type=checkbox id=section-33ac730897af6feca81c1fdb7869c57e class=toggle>
<label for=section-33ac730897af6feca81c1fdb7869c57e class="flex justify-between"><a href=/tech-book/docs/manageability/why-grpc-on-http2/>gRPC on HTTP/2</a></label></li></ul></li><li><input type=checkbox id=section-c14ae944424668ef125e10cd791a3d3d class=toggle>
<label for=section-c14ae944424668ef125e10cd791a3d3d class="flex justify-between"><a href=/tech-book/docs/networking-tips/>Networking Tips</a></label><ul><li><input type=checkbox id=section-78fdf21c03c55935d3146441b06faf3e class=toggle>
<label for=section-78fdf21c03c55935d3146441b06faf3e class="flex justify-between"><a href=/tech-book/docs/networking-tips/dns/>DNS Overview</a></label></li><li><input type=checkbox id=section-bbcb027a658dc7a2333d59078ee507f9 class=toggle>
<label for=section-bbcb027a658dc7a2333d59078ee507f9 class="flex justify-between"><a href=/tech-book/docs/networking-tips/ecmp/>ECMP Load Balancing</a></label></li><li><input type=checkbox id=section-3b39b86f18b3451e5b8a1b81c369549c class=toggle>
<label for=section-3b39b86f18b3451e5b8a1b81c369549c class="flex justify-between"><a href=/tech-book/docs/networking-tips/ip-fragmentation/>IP Fragmentation - IPv4 & IPv6</a></label></li><li><input type=checkbox id=section-c6d06c54cc91b0bc3f948d33b437fa8b class=toggle>
<label for=section-c6d06c54cc91b0bc3f948d33b437fa8b class="flex justify-between"><a href=/tech-book/docs/networking-tips/ip-tos-dscp/>IP Precedence And TOS | DSCP</a></label></li><li><input type=checkbox id=section-5f3260c76dd37177e3f89057bfe520ae class=toggle>
<label for=section-5f3260c76dd37177e3f89057bfe520ae class="flex justify-between"><a href=/tech-book/docs/networking-tips/traceroute/>Linux traceroute tool</a></label></li><li><input type=checkbox id=section-a26cc3fafb36cbc55527adf39ec83849 class=toggle>
<label for=section-a26cc3fafb36cbc55527adf39ec83849 class="flex justify-between"><a href=/tech-book/docs/networking-tips/mlag/>Multi Chassis Link Aggregation Basics</a></label></li><li><input type=checkbox id=section-36409a0abcb2d4d4baf2e0b682d1a5dd class=toggle>
<label for=section-36409a0abcb2d4d4baf2e0b682d1a5dd class="flex justify-between"><a href=/tech-book/docs/networking-tips/qos/>QoS</a></label></li><li><input type=checkbox id=section-db41e3547d316b01acf9a0ce9c04ef34 class=toggle>
<label for=section-db41e3547d316b01acf9a0ce9c04ef34 class="flex justify-between"><a href=/tech-book/docs/networking-tips/spine-leaf-arch/>Spine-leaf Architecture Basics</a></label></li><li><input type=checkbox id=section-0eb0d409074a76b8cb02624655e2434d class=toggle>
<label for=section-0eb0d409074a76b8cb02624655e2434d class="flex justify-between"><a href=/tech-book/docs/networking-tips/tcp-congestion/>TCP Congestion Control</a></label></li><li><input type=checkbox id=section-3d1710947b3c5be1a1cc33d88fcc6f54 class=toggle>
<label for=section-3d1710947b3c5be1a1cc33d88fcc6f54 class="flex justify-between"><a href=/tech-book/docs/networking-tips/tcp-data-transfer/>TCP Data Transfer</a></label></li></ul></li><li><input type=checkbox id=section-f0a392f2f083f28a4991336773716a63 class=toggle>
<label for=section-f0a392f2f083f28a4991336773716a63 class="flex justify-between"><a href=/tech-book/docs/optical-knowledge/>Optical Knowledge</a></label><ul><li><input type=checkbox id=section-18261b95a92d4fa86116243edca4e9fb class=toggle>
<label for=section-18261b95a92d4fa86116243edca4e9fb class="flex justify-between"><a href=/tech-book/docs/optical-knowledge/optical-breakout/>Optical Transceiver(Grey) & Breakout Model</a></label></li></ul></li><li><input type=checkbox id=section-a55840d746138b3d1fedb81acbccdded class=toggle>
<label for=section-a55840d746138b3d1fedb81acbccdded class="flex justify-between"><a href=/tech-book/docs/programming-tips/>Programming Tips</a></label><ul><li><input type=checkbox id=section-f929f1fe13cb5d6cc96ca3e98f9d9777 class=toggle>
<label for=section-f929f1fe13cb5d6cc96ca3e98f9d9777 class="flex justify-between"><a href=/tech-book/docs/programming-tips/c++/>C++ Tips</a></label></li></ul></li><li><input type=checkbox id=section-b35dbf5ebcd4c19926cf5a9aab6c7655 class=toggle checked>
<label for=section-b35dbf5ebcd4c19926cf5a9aab6c7655 class="flex justify-between"><a href=/tech-book/docs/systemdesign-tips/>SystemDesign-Tips</a></label><ul><li><input type=checkbox id=section-4a618bc3b0b30107f0cec6d3bd6c025f class=toggle checked>
<label for=section-4a618bc3b0b30107f0cec6d3bd6c025f class="flex justify-between"><a href=/tech-book/docs/systemdesign-tips/code-deployment-system/ class=active>Design A Code-Deployment System</a></label></li><li><input type=checkbox id=section-e600754306aa95ce9c5a72b5efec6d7a class=toggle>
<label for=section-e600754306aa95ce9c5a72b5efec6d7a class="flex justify-between"><a href=/tech-book/docs/systemdesign-tips/stock-broker/>Design A Stock-Broker System</a></label></li><li><input type=checkbox id=section-bfa7a29878f65cfbb179e491c1211fa8 class=toggle>
<label for=section-bfa7a29878f65cfbb179e491c1211fa8 class="flex justify-between"><a href=/tech-book/docs/systemdesign-tips/design-amazon/>Design Amazon</a></label></li><li><input type=checkbox id=section-5456837e25872f6352d861a9b5662cb1 class=toggle>
<label for=section-5456837e25872f6352d861a9b5662cb1 class="flex justify-between"><a href=/tech-book/docs/systemdesign-tips/design-slack/>Design Slack</a></label></li><li><input type=checkbox id=section-5a78d16f54536a400b654f17f917bce1 class=toggle>
<label for=section-5a78d16f54536a400b654f17f917bce1 class="flex justify-between"><a href=/tech-book/docs/systemdesign-tips/google-drive/>Google Drive - Design</a></label></li></ul></li></ul><ul><li><a href=/tech-book/posts/>Blog</a></li><li><a href=https://prasenjitmanna.com/ target=_blank rel=noopener>Prasenjit's Blog</a></li><li><a href=https://prasenjitmanna.com/tech-book/ target=_blank rel=noopener>Prasenjit - Tech Book</a></li><li><a href=https://prasenjitmanna.com/upskills/ target=_blank rel=noopener>Prasenjit - Upskills</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/tech-book/svg/menu.svg class=book-icon alt=Menu>
</label><strong>Design A Code-Deployment System</strong>
<label for=toc-control><img src=/tech-book/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#1-gathering-system-requirements>1. Gathering System Requirements</a></li><li><a href=#2-coming-up-with-a-plan>2. Coming Up With A Plan</a></li><li><a href=#3-build-system----general-overview>3. Build System &ndash; General Overview</a></li><li><a href=#4-build-system----job-queue>4. Build System &ndash; Job Queue</a></li><li><a href=#5-build-system----sql-job-queue>5. Build System &ndash; SQL Job Queue</a></li><li><a href=#6-build-system----concurrency>6. Build System &ndash; Concurrency</a></li><li><a href=#7-build-system----lost-jobs>7. Build System &ndash; Lost Jobs</a></li><li><a href=#8-build-system----scale-estimation>8. Build System &ndash; Scale Estimation</a></li><li><a href=#9-build-system----storage>9. Build System &ndash; Storage</a></li><li><a href=#10-deployment-system----general-overview>10. Deployment System &ndash; General Overview</a></li><li><a href=#11-deployment-system----replication-status-service>11. Deployment System &ndash; Replication-Status Service</a></li><li><a href=#12-deployment-system----blob-distribution>12. Deployment System &ndash; Blob Distribution</a></li><li><a href=#13-deployment-system----trigger>13. Deployment System &ndash; Trigger</a></li><li><a href=#14-system-diagram>14. System Diagram</a></li></ul></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h3 id=1-gathering-system-requirements>1. Gathering System Requirements
<a class=anchor href=#1-gathering-system-requirements>#</a></h3><p>As with any systems design interview question, the first thing that we want to do is to gather system requirements; we need to figure out what system we&rsquo;re building exactly.</p><p>From the answers we were given to our clarifying questions (see Prompt Box), we&rsquo;re building a system that involves repeatedly (in the order of thousands of times per day) building and deploying code to hundreds of thousands of machines spread out across <strong>5-10 regions around</strong> the world.</p><p>Building code will involve grabbing snapshots of source code using commit SHA identifiers; beyond that, we can assume that the actual implementation details of the building action are taken care of. In other words, we don&rsquo;t need to worry about how we would build JavaScript code or C++ code; we just need to design the system that enables the repeated building of code.</p><p>Building code will take up to <strong>15 minutes</strong>, it&rsquo;ll result in a binary file of <strong>up to 10GB</strong>, and we want to have the entire deployment process (building and deploying code to our target machines) take at most <strong>30 minutes.</strong></p><p>Each build will need a clear end-state (SUCCESS or FAILURE), and though we care about availability (2 to 3 nines), we don&rsquo;t need to optimize too much on this dimension.</p><h3 id=2-coming-up-with-a-plan>2. Coming Up With A Plan
<a class=anchor href=#2-coming-up-with-a-plan>#</a></h3><p>It&rsquo;s important to organize ourselves and to lay out a clear plan regarding how we&rsquo;re going to tackle our design. What are the major, distinguishable components of our how system?</p><p>It seems like this system can actually very simply be divided into two clear subsystems:</p><ul><li>the Build System that builds code into binaries</li><li>the Deployment System that deploys binaries to our machines across the world</li></ul><p>Note that these subsystems will of course have many components themselves, but this is a very straightforward initial way to approach our problem.</p><h3 id=3-build-system----general-overview>3. Build System &ndash; General Overview
<a class=anchor href=#3-build-system----general-overview>#</a></h3><p>From a high-level perspective, we can call the process of building code into a binary a <strong>job</strong>, and we can design our build system as a queue of jobs. Jobs get added to the queue, and each job has a commit identifier (the commit SHA) for what version of the code it should build and the name of the artifact that will be created (the name of the resulting binary). Since we&rsquo;re agnostic to the type of the code being built, we can assume that all languages are handled automatically here.</p><p>We can have a pool of servers (workers) that are going to handle all of these jobs. Each worker will repeatedly take jobs off the queue (in a <strong>FIFO manner</strong>—no prioritization for now), build the relevant binaries (again, we&rsquo;re assuming that the actual implementation details of building code are given to us), and write the resulting binaries to blob storage (<strong>Google Cloud Storage</strong> or <strong>S3</strong> for instance). Blob storage makes sense here, because binaries are literally blobs of data.</p><h3 id=4-build-system----job-queue>4. Build System &ndash; Job Queue
<a class=anchor href=#4-build-system----job-queue>#</a></h3><p>A naive design of the job queue would have us implement it in memory (just as we would implement a queue in coding interviews), but this implementation is very problematic; if there&rsquo;s a failure in our servers that hold this queue, we lose the entire state of our jobs: queued jobs and past jobs.</p><p>It seems like we would be unnecessarily complicating matters by trying to optimize around this in-memory type of storage, so we&rsquo;re likely better off implementing the queue using a SQL database.</p><h3 id=5-build-system----sql-job-queue>5. Build System &ndash; SQL Job Queue
<a class=anchor href=#5-build-system----sql-job-queue>#</a></h3><p>We can have a <strong>jobs</strong> table in our SQL database where every record in the database represents a job, and we can use record-creation timestamps as the queue&rsquo;s ordering mechanism.</p><p>Our table will be:</p><ul><li>id: <em>string</em>, the ID of the job, auto-generated</li><li>created_at: <em>timestamp</em></li><li>commit_sha: <em>string</em></li><li>name: <em>string</em>, the pointer to the job&rsquo;s eventual binary in blob storage</li><li>status: <em>string</em>, <strong>QUEUED</strong>, <strong>RUNNING</strong>, <strong>SUCCEEDED</strong>, <strong>FAILED</strong></li></ul><p>We can implement the actual dequeuing mechanism by looking at the oldest creation_timestamp with a QUEUED status. This means that we&rsquo;ll likely want to index our table on both created_at and status.</p><h3 id=6-build-system----concurrency>6. Build System &ndash; Concurrency
<a class=anchor href=#6-build-system----concurrency>#</a></h3><p><strong>ACID transactions</strong> will make it safe for potentially hundreds of workers to grab jobs off the queue without unintentionally running the same job twice (we&rsquo;ll avoid race conditions). Our actual transaction will look like this:</p><pre tabindex=0><code>  BEGIN TRANSACTION;
  SELECT * FROM jobs_table WHERE status = &#39;QUEUED&#39; ORDER BY created_at ASC LIMIT 1;
  // if there&#39;s none, we ROLLBACK;
  UPDATE jobs_table SET status = &#39;RUNNING&#39; WHERE id = id from previous query;
  COMMIT;
</code></pre><p>All of the workers will be running this transaction every so often to dequeue the next job; let&rsquo;s say every 5 seconds. If we arbitrarily assume that we&rsquo;ll have 100 workers sharing the same queue, we&rsquo;ll have 100/5 = 20 reads per second, which is very easy to handle for a SQL database.</p><h3 id=7-build-system----lost-jobs>7. Build System &ndash; Lost Jobs
<a class=anchor href=#7-build-system----lost-jobs>#</a></h3><p>Since we&rsquo;re designing a large-scale system, we have to expect and handle edge cases. Here, what if there&rsquo;s a network partition with our workers or one of our workers dies mid-build? Since builds last around 15 minutes on average, this will very likely happen. In this case, we want to avoid having a &ldquo;lost job&rdquo; that we were never made aware of, and with our current design, the job will remain RUNNING forever. How do we handle this?</p><p>We could have an extra column on our <strong>jobs</strong> table called last_heartbeat. This will be updated in a heartbeat fashion by the worker running a particular job, where that worker will update the relevant row in the table every 3-5 minutes to just let us know that it&rsquo;s still running the job.</p><p>We can then have a completely separate service that polls the table every so often (say, every 5 minutes, depending on how responsive we want this build system to be), checks all of the <strong>RUNNING</strong> jobs, and if their last_heartbeat was last modified longer than 2 heartbeats ago (we need some margin of error here), then something&rsquo;s likely wrong, and this service can reset the status of the relevant jobs to <strong>QUEUED</strong>, which would effectively bring them back to the front of the queue.</p><p>The transaction that this auxiliary service will perform will look something like this:</p><pre tabindex=0><code>  UPDATE jobs_table SET status = &#39;QUEUED&#39; WHERE
    status = &#39;RUNNING&#39; AND
    last_heartbeat &lt; NOW() - 10 minutes;
</code></pre><h3 id=8-build-system----scale-estimation>8. Build System &ndash; Scale Estimation
<a class=anchor href=#8-build-system----scale-estimation>#</a></h3><p>We previously arbitrarily assumed that we would have 100 workers, which made our SQL-database queue able to handle the expected load. We should try to estimate if this number of workers is actually realistic.</p><p>With some back-of-the-envelope math, we can see that, since a build can take up to 15 minutes, a single worker can run 4 jobs per hour, or ~100 (96) jobs per day. Given thousands of builds per day (say, 5000-10000), this means that we would need <strong>50-100 workers</strong> (5000 / 100). So our arbitrary figure was accurate.</p><p>Even if the builds aren&rsquo;t uniformly spread out (in other words, they peak during work hours), our system scales horizontally very easily. We can automatically add or remove workers whenever the load warrants it. We can also scale our system vertically by making our workers more powerful, thereby reducing the build time.</p><h3 id=9-build-system----storage>9. Build System &ndash; Storage
<a class=anchor href=#9-build-system----storage>#</a></h3><p>We previously mentioned that we would store binaries in blob storage (<strong>GCS</strong>). Where does this storage fit into our queueing system exactly?</p><p>When a worker completes a build, it can store the binary in GCS <em>before</em> updating the relevant row in the <strong>jobs</strong> table. This will ensure that a binary has been persisted before its relevant job is marked as <strong>SUCCEEDED</strong>.</p><p>Since we&rsquo;re going to be deploying our binaries to machines spread across the world, it&rsquo;ll likely make sense to have regional storage rather than just a single global blob store.</p><p>We can design our system based on regional clusters around the world (in our 5-10 global regions). Each region can have a blob store (a regional GCS bucket). Once a worker successfully stores a binary in our main blob store, the worker is released and can run another job, while the main blob store performs some asynchronous replication to store the binary in all of the regional GCS buckets. Given 5-10 regions and 10GB files, this step should take no more than 5-10 minutes, bringing our total build-and-deploy duration so far to roughly 20-25 minutes (15 minutes for a build and 5-10 minutes for global replication of the binary).</p><h3 id=10-deployment-system----general-overview>10. Deployment System &ndash; General Overview
<a class=anchor href=#10-deployment-system----general-overview>#</a></h3><p>From a high-level perspective, our actual deployment system will need to allow for the very fast distribution of 10GB binaries to hundreds of thousands of machines across all of our global regions. We&rsquo;re likely going to want some service that tells us when a binary has been replicated in all regions, another service that can serve as the source of truth for what binary should currently be run on all machines, and finally a peer-to-peer-network design for our actual machines across the world.</p><h3 id=11-deployment-system----replication-status-service>11. Deployment System &ndash; Replication-Status Service
<a class=anchor href=#11-deployment-system----replication-status-service>#</a></h3><p>We can have a global service that continuously checks all regional GCS buckets and aggregates the replication status for successful builds (in other words, checks that a given binary in the main blob store has been replicated across all regions). Once a binary has been replicated across all regions, this service updates a separate SQL database with rows containing the name of a binary and a <strong>replication_status</strong>. Once a binary has a &ldquo;complete&rdquo; <strong>replication_status</strong>, it&rsquo;s officially deployable.</p><h3 id=12-deployment-system----blob-distribution>12. Deployment System &ndash; Blob Distribution
<a class=anchor href=#12-deployment-system----blob-distribution>#</a></h3><p>Since we&rsquo;re going to deploy 10 GBs to hundreds of thousands of machines, even with our regional clusters, having each machine download a 10GB file one after the other from a regional blob store is going to be extremely slow. A peer-to-peer-network approach will be much faster and will allow us to hit our 30-minute time frame for deployments. All of our regional clusters will behave as peer-to-peer networks.</p><h3 id=13-deployment-system----trigger>13. Deployment System &ndash; Trigger
<a class=anchor href=#13-deployment-system----trigger>#</a></h3><p>Let&rsquo;s describe what happens when an engineer presses a button on some internal UI that says &ldquo;Deploy build/binary B1 to every machine globally&rdquo;. This is the action that triggers the binary downloads on all the regional peer-to-peer networks.</p><p>To simplify this process and to support having multiple builds getting deployed concurrently, we can design this in a goal-state oriented manner.</p><p>The goal-state will be the desired build version at any point in time and will look something like: &ldquo;current_build: <strong>B1</strong>&rdquo;, and this can be stored in some dynamic configuration service (a <strong>key-value store</strong> like <strong>Etcd</strong> or <strong>ZooKeeper</strong>). We&rsquo;ll have a global goal-state as well as regional goal-states.</p><p>Each regional cluster will have a K-V store that holds configuration for that cluster about what builds should be running on that cluster, and we&rsquo;ll also have a global K-V store.</p><p>When an engineer clicks the &ldquo;Deploy build/binary B1&rdquo; button, our global K-V store&rsquo;s build_version will get updated. Regional K-V stores will be continuously polling the global K-V store (say, every 10 seconds) for updates to the build_version and will update themselves accordingly.</p><p>Machines in the clusters/regions will be polling the relevant regional K-V store, and when the build_version changes, they&rsquo;ll try to fetch that build from the P2P network and run the binary.</p><h3 id=14-system-diagram>14. System Diagram
<a class=anchor href=#14-system-diagram>#</a></h3><p>Final Systems Architecture</p><p><img src=https://prasenjitmanna.com/tech-book/diagrams/code-deployment-system-diagram.svg alt=img|320x271></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/prmanna/tech-book/commit/8c397398043ffce3292e8423334eb6ea9c45c4e8 title='Last modified by Prasenjit Manna | May 8, 2025' target=_blank rel=noopener><img src=/tech-book/svg/calendar.svg class=book-icon alt>
<span>May 8, 2025</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#1-gathering-system-requirements>1. Gathering System Requirements</a></li><li><a href=#2-coming-up-with-a-plan>2. Coming Up With A Plan</a></li><li><a href=#3-build-system----general-overview>3. Build System &ndash; General Overview</a></li><li><a href=#4-build-system----job-queue>4. Build System &ndash; Job Queue</a></li><li><a href=#5-build-system----sql-job-queue>5. Build System &ndash; SQL Job Queue</a></li><li><a href=#6-build-system----concurrency>6. Build System &ndash; Concurrency</a></li><li><a href=#7-build-system----lost-jobs>7. Build System &ndash; Lost Jobs</a></li><li><a href=#8-build-system----scale-estimation>8. Build System &ndash; Scale Estimation</a></li><li><a href=#9-build-system----storage>9. Build System &ndash; Storage</a></li><li><a href=#10-deployment-system----general-overview>10. Deployment System &ndash; General Overview</a></li><li><a href=#11-deployment-system----replication-status-service>11. Deployment System &ndash; Replication-Status Service</a></li><li><a href=#12-deployment-system----blob-distribution>12. Deployment System &ndash; Blob Distribution</a></li><li><a href=#13-deployment-system----trigger>13. Deployment System &ndash; Trigger</a></li><li><a href=#14-system-diagram>14. System Diagram</a></li></ul></li></ul></li></ul></nav></div></aside></main></body></html>