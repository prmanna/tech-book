<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="1. Gathering System Requirements # As with any systems design interview question, the first thing that we want to do is to gather system requirements; we need to figure out what system we&rsquo;re building exactly.
We&rsquo;re designing the e-commerce side of the Amazon website, and more specifically, the system that supports users searching for items on the Amazon home page, adding items to cart, submitting orders, and those orders being assigned to relevant Amazon warehouses for shipment."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="Design Amazon"><meta property="og:description" content="1. Gathering System Requirements # As with any systems design interview question, the first thing that we want to do is to gather system requirements; we need to figure out what system we&rsquo;re building exactly.
We&rsquo;re designing the e-commerce side of the Amazon website, and more specifically, the system that supports users searching for items on the Amazon home page, adding items to cart, submitting orders, and those orders being assigned to relevant Amazon warehouses for shipment."><meta property="og:type" content="article"><meta property="og:url" content="https://prasenjitmanna.com/tech-book/docs/systemdesign-tips/design-amazon/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2024-03-09T23:27:16+05:30"><title>Design Amazon | Technical Book</title><link rel=manifest href=/tech-book/manifest.json><link rel=icon href=/tech-book/favicon.png type=image/x-icon><link rel=stylesheet href=/tech-book/book.min.46181bc93375ba932026e753b37c40e6ff8bb16a9ef770c78bcc663e4577b1ba.css integrity="sha256-RhgbyTN1upMgJudTs3xA5v+LsWqe93DHi8xmPkV3sbo=" crossorigin=anonymous><script defer src=/tech-book/flexsearch.min.js></script>
<script defer src=/tech-book/en.search.min.3a124ce33ed4d9451487ebfaf59fad0c49cde7620343fe005da197d2c3c7c2fc.js integrity="sha256-OhJM4z7U2UUUh+v69Z+tDEnN52IDQ/4AXaGX0sPHwvw=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/tech-book/><img src=/tech-book/logo.png alt=Logo><span>Technical Book</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><input type=checkbox id=section-374f93193c235d5a59a63115829f835e class=toggle>
<label for=section-374f93193c235d5a59a63115829f835e class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/algorithms/>Algorithms</a></label><ul><li><input type=checkbox id=section-8729b110b30a06da65be45e52f9e3fb7 class=toggle>
<label for=section-8729b110b30a06da65be45e52f9e3fb7 class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/algorithms/easy/>Easy Complexity</a></label></li><li><input type=checkbox id=section-099794dc84dde9d1e65baa1aa530d340 class=toggle>
<label for=section-099794dc84dde9d1e65baa1aa530d340 class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/algorithms/two-pointers/>Two Pointers</a></label></li><li><input type=checkbox id=section-df4c4c540e3dcef48dcd2d00c3965057 class=toggle>
<label for=section-df4c4c540e3dcef48dcd2d00c3965057 class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/algorithms/medium/>Medium Complexity</a></label></li></ul></li><li><input type=checkbox id=section-ea5c43baf485397e13cba9de36dde795 class=toggle>
<label for=section-ea5c43baf485397e13cba9de36dde795 class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/programming-tips/>Programming Tips</a></label><ul></ul></li><li><input type=checkbox id=section-e1ca16f5998b918e4e01f395e9c81195 class=toggle checked>
<label for=section-e1ca16f5998b918e4e01f395e9c81195 class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/systemdesign-tips/>SystemDesign-Tips</a></label><ul><li><input type=checkbox id=section-cd24c01774f2ef0254c419c2af253650 class=toggle>
<label for=section-cd24c01774f2ef0254c419c2af253650 class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/systemdesign-tips/code-deployment-system/>Design A Code-Deployment System</a></label></li><li><input type=checkbox id=section-9c8d84ec532d2a2d7bafc9a630fe088a class=toggle>
<label for=section-9c8d84ec532d2a2d7bafc9a630fe088a class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/systemdesign-tips/stock-broker/>Design A Stock-Broker System</a></label></li><li><input type=checkbox id=section-0f676c3118d30de407a723723e27de91 class=toggle checked>
<label for=section-0f676c3118d30de407a723723e27de91 class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/systemdesign-tips/design-amazon/ class=active>Design Amazon</a></label></li><li><input type=checkbox id=section-de7910a662f896155a583da23f7844c9 class=toggle>
<label for=section-de7910a662f896155a583da23f7844c9 class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/systemdesign-tips/design-slack/>Design Slack</a></label></li><li><input type=checkbox id=section-81d594663dd77ffbd855c8bfc64baf2e class=toggle>
<label for=section-81d594663dd77ffbd855c8bfc64baf2e class="flex justify-between"><a href=https://prasenjitmanna.com/tech-book/docs/systemdesign-tips/google-drive/>Google Drive - Design</a></label></li></ul></li></ul><ul><li><a href=/tech-book/posts/>Blog</a></li><li><a href=https://prasenjitmanna.com/tech-book/ target=_blank rel=noopener>Technical Book</a></li><li><a href=https://prasenjitmanna.com/ target=_blank rel=noopener>Prasenjit's blog</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/tech-book/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Design Amazon</strong>
<label for=toc-control><img src=/tech-book/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#1-gathering-system-requirements>1. Gathering System Requirements</a></li><li><a href=#2-coming-up-with-a-plan>2. Coming Up With A Plan</a></li><li><a href=#3-high-level-system-overview>3. High-Level System Overview</a></li><li><a href=#4-sql-tables>4. SQL Tables</a></li><li><a href=#5-core-user-functionality>5. Core User Functionality</a></li><li><a href=#6-core-warehouse-functionality>6. Core Warehouse Functionality</a></li><li><a href=#7-system-diagram>7. System Diagram</a></li></ul></li></ul></li></ul></nav></aside></header><article class=markdown><h3 id=1-gathering-system-requirements>1. Gathering System Requirements
<a class=anchor href=#1-gathering-system-requirements>#</a></h3><p>As with any systems design interview question, the first thing that we want to do is to gather system requirements; we need to figure out what system we&rsquo;re building exactly.</p><p>We&rsquo;re designing the e-commerce side of the Amazon website, and more specifically, the system that supports users searching for items on the Amazon home page, adding items to cart, submitting orders, and those orders being assigned to relevant Amazon warehouses for shipment.</p><p>We need to handle items going out of stock, and we&rsquo;ve been given some guidelines for a simple &ldquo;stock-reservation&rdquo; system when users begin the checkout process.</p><p>We have access to two smart services: one that handles user search queries and one that handles warehouse order assignment. It&rsquo;s our job to figure out how these services fit into our larger design.</p><p>We&rsquo;ll specifically be designing the system that supports amazon.com (i.e., Amazon&rsquo;s U.S. operations), and we&rsquo;ll assume that this system can be replicated for other regional Amazon stores. For the rest of this walkthrough, whenever we refer to &ldquo;Amazon,&rdquo; we&rsquo;ll be referring specifically to Amazon&rsquo;s U.S. store.</p><p>While the system should have low latency when searching for items and high availability in general, serving roughly 10 orders per second in the U.S., we&rsquo;ve been told to focus mostly on core functionality.</p><h3 id=2-coming-up-with-a-plan>2. Coming Up With A Plan
<a class=anchor href=#2-coming-up-with-a-plan>#</a></h3><p>We&rsquo;ll tackle this system by first looking at a high-level overview of how it&rsquo;ll be set up, then diving into its storage components, and finally looking at how the core functionality comes to life. We can divide the core functionality into two main sections:</p><ul><li>The user side.</li><li>The warehouse side.</li></ul><p>We can further divide the user side as follows:</p><ul><li>Browsing items given a search term.</li><li>Modifying the cart.</li><li>Beginning the checkout process.</li><li>Submitting and canceliing orders.</li></ul><h3 id=3-high-level-system-overview>3. High-Level System Overview
<a class=anchor href=#3-high-level-system-overview>#</a></h3><p>Within a region, user and warehouse requests will get round-robin-load-balanced to respective sets of API servers, and data will be written to and read from a SQL database for that region.</p><p>We&rsquo;ll go with a SQL database because all of the data that we&rsquo;ll be dealing with (items, carts, orders, etc.) is, by nature, structured and lends itself well to a relational model.</p><h3 id=4-sql-tables>4. SQL Tables
<a class=anchor href=#4-sql-tables>#</a></h3><p>We&rsquo;ll have six SQL tables to support our entire system&rsquo;s storage needs.</p><p><strong>Items</strong></p><p>This table will store all of the items on Amazon, with each row representing an item.</p><table><thead><tr><th>itemId: uuid</th><th>name: string</th><th>description: string</th><th>price: integer</th><th>currency: enum</th><th>other&mldr;</th></tr></thead><tbody><tr><td>&mldr;</td><td>&mldr;</td><td>&mldr;</td><td>&mldr;</td><td>&mldr;</td><td>&mldr;</td></tr></tbody></table><p><strong>Carts</strong></p><p>This table will store all of the carts on Amazon, with each row representing a cart. We&rsquo;ve been told that each user can only have a single cart at once.</p><table><thead><tr><th>cartId: uuid</th><th>customerId: uuid</th><th>items: []{itemId, quantity}</th></tr></thead><tbody><tr><td>&mldr;</td><td>&mldr;</td><td>&mldr;</td></tr></tbody></table><p><strong>Orders</strong></p><p>This table will store all of the orders on Amazon, with each row representing an order.</p><p>| orderId: uuid | customerId: uuid | orderStatus: enum | items: []{itemId, quantity} | price: integer | paymentInfo: PaymentInfo | shippingAddress: string | timestamp: datetime | other&mldr; |
| &mdash;&mdash;&mdash;&mdash; | &mdash;&mdash;&mdash;&mdash;&ndash; | &mdash;&mdash;&mdash;&mdash;&mdash;&ndash; | &mdash;&mdash;&mdash;&mdash;&mdash;- | &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;- | &mdash;&mdash;&mdash;&mdash;&ndash; |
| &mldr; | &mldr; | &mldr; | &mldr; | &mldr; | &mldr; | &mldr; | &mldr; | &mldr;|</p><p><strong>Aggregated Stock</strong></p><p>This table will store all of the item stocks on Amazon that are relevant to users, with each row representing an item. See the Core User Functionality section for more details.</p><table><thead><tr><th>itemId: uuid</th><th>stock: integer</th></tr></thead><tbody><tr><td>&mldr;</td><td>&mldr;</td></tr></tbody></table><p><strong>Warehouse Orders</strong></p><p>This table will store all of the orders that Amazon warehouses get, with each row representing a warehouse order. Warehouse orders are either entire normal Amazon orders or subsets of normal Amazon orders.</p><table><thead><tr><th>warehouseOrderId: uuid</th><th>parentOrderId: uuid</th><th>warehouseId: uuid</th><th>orderStatus: enum</th><th>items: []{itemId, quantity}</th><th>shippingAddress: string</th></tr></thead><tbody><tr><td>&mldr;</td><td>&mldr;</td><td>&mldr;</td><td>&mldr;</td><td>&mldr;</td><td>&mldr;</td></tr></tbody></table><p><strong>Warehouse Stock</strong></p><p>This table will store all of the item stocks in Amazon warehouses, with each row representing an {item, warehouse} pairing. The physicalStock field represents an item&rsquo;s actual physical stock in the warehouse in question, serving as a source of truth, while the availableStock field represents an item&rsquo;s effective available stock in the relevant warehouse; this stock gets decreased when orders are assigned to warehouses. See the Core Warehouse Functionality section for more details.</p><table><thead><tr><th>itemId: uuid</th><th>warehouseId: uuid</th><th>physicalStock: integer</th><th>availableStock: integer</th></tr></thead><tbody><tr><td>&mldr;</td><td>&mldr;</td><td>&mldr;</td><td>&mldr;</td></tr></tbody></table><h3 id=5-core-user-functionality>5. Core User Functionality
<a class=anchor href=#5-core-user-functionality>#</a></h3><p><strong>GetItemCatalog(search)</strong></p><p>This is the endpoint that users call when they&rsquo;re searching for items. The request is routed by API servers to the smart search-results service, which interacts directly with the items table, caches popular item searches, and returns the results.</p><p>The API servers also fetch the relevant item stocks from the aggregated_stock table.</p><p><strong>UpdateCartItemQuantity(itemId, quantity)</strong></p><p>This is the endpoint that users call when they&rsquo;re adding or removing items from their cart. The request writes directly to the carts table, and users can only call this endpoint when an item has enough stock in the aggregated_stock table.</p><p><strong>BeginCheckout() & CancelCheckout()</strong></p><p>These are the endpoints that users call when they&rsquo;re beginning the checkout process and cancelling it. The BeginCheckout request triggers another read of the aggregated_stock table for the relevant items. If some of the items in the cart don&rsquo;t have enough stock anymore, the UI alerts the users accordingly. For items that do have enough stock, the API servers write to the aggregated_stock table and decrease the relevant stocks accordingly, effectively &ldquo;reserving&rdquo; the items during the duration of the checkout. The CancelCheckout request, which also gets automatically called after 10 minutes of being in the checkout process, writes to the aggregated_stock table and increases the relevant stocks accordingly, thereby &ldquo;unreserving&rdquo; the items. Note that all of the writes to the aggregated_stock are ACID transactions, which allows us to comfortably rely on this SQL table as far as stock correctness is concerned.</p><p><strong>SubmitOrder(), CancelOrder(), & GetMyOrders()</strong></p><p>These are the endpoints that users call when they&rsquo;re submitting and cancelling orders. Both the SubmitOrder and CancelOrder requests write to the orders table, and CancelOrder also writes to the aggregated_stock table, increasing the relevant stocks accordingly (SubmitOrder doesn&rsquo;t need to because the checkout process already has). GetMyOrders simply reads from the orders table. Note that an order can only be cancelled if it hasn&rsquo;t yet been shipped, which is knowable from the orderStatus field.</p><h3 id=6-core-warehouse-functionality>6. Core Warehouse Functionality
<a class=anchor href=#6-core-warehouse-functionality>#</a></h3><p>On the warehouse side of things, we&rsquo;ll have the smart order-assignment service read from the orders table, figure out the best way to split orders up and assign them to warehouses based on shipping addresses, item stocks, and other data points, and write the final warehouse orders to the warehouse_orders table.</p><p>In order to know which warehouses have what items and how many, the order-assignment service will rely on the availableStock of relevant items in the warehouse_stock table. When the service assigns an order to a warehouse, it decreases the availableStock of the relevant items for the warehouse in question in the warehouse_stock table. These availableStock values are re-increased by the relevant warehouse if its order ends up being cancelled.</p><p>When warehouses get new item stock, lose item stock for whatever reason, or physically ship their assigned orders, they&rsquo;ll update the relevant physicalStock values in the warehouse_stock table. If they get new item stock or lose item stock, they&rsquo;ll also write to the aggregated_stock table (they don&rsquo;t need to do this when shipping assigned orders, since the aggregated_stock table already gets updated by the checkout process on the user side of things).</p><h3 id=7-system-diagram>7. System Diagram
<a class=anchor href=#7-system-diagram>#</a></h3><p>Final Systems Architecture</p><p><img src=https://prasenjitmanna.com/tech-book/diagrams/amazon-system-diagram.svg alt=img|320x271></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/prmanna/tech-book/commit/c0476873a1923d9747606f92d589daab415e4af9 title='Last modified by Prasenjit Manna | March 9, 2024' target=_blank rel=noopener><img src=/tech-book/svg/calendar.svg class=book-icon alt=Calendar>
<span>March 9, 2024</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#1-gathering-system-requirements>1. Gathering System Requirements</a></li><li><a href=#2-coming-up-with-a-plan>2. Coming Up With A Plan</a></li><li><a href=#3-high-level-system-overview>3. High-Level System Overview</a></li><li><a href=#4-sql-tables>4. SQL Tables</a></li><li><a href=#5-core-user-functionality>5. Core User Functionality</a></li><li><a href=#6-core-warehouse-functionality>6. Core Warehouse Functionality</a></li><li><a href=#7-system-diagram>7. System Diagram</a></li></ul></li></ul></li></ul></nav></div></aside></main></body></html>