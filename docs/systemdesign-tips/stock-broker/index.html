<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  1. Gathering System Requirements
  #

As with any systems design interview question, the first thing that we want to do is to gather system requirements; we need to figure out what system we&rsquo;re building exactly.
We&rsquo;re building a stock-brokerage platform like Robinhood that functions as the intermediary between end-customers and some central stock exchange. The idea is that the central stock exchange is the platform that actually executes stock trades, whereas the stockbroker is just the platform that customers talk to when they want to place a trade&ndash;the stock brokerage is &ldquo;simpler&rdquo; and more &ldquo;human-readable&rdquo;, so to speak."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://prasenjitmanna.com/tech-book/docs/systemdesign-tips/stock-broker/"><meta property="og:site_name" content="Technical Book"><meta property="og:title" content="Design A Stock-Broker System"><meta property="og:description" content=" 1. Gathering System Requirements # As with any systems design interview question, the first thing that we want to do is to gather system requirements; we need to figure out what system we’re building exactly.
We’re building a stock-brokerage platform like Robinhood that functions as the intermediary between end-customers and some central stock exchange. The idea is that the central stock exchange is the platform that actually executes stock trades, whereas the stockbroker is just the platform that customers talk to when they want to place a trade–the stock brokerage is “simpler” and more “human-readable”, so to speak."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2025-05-15T13:41:12+05:30"><title>Design A Stock-Broker System | Technical Book</title>
<link rel=manifest href=/tech-book/manifest.json><link rel=icon href=/tech-book/favicon.png><link rel=canonical href=https://prasenjitmanna.com/tech-book/docs/systemdesign-tips/stock-broker/><link rel=stylesheet href=/tech-book/book.min.a61cdb2979f3c2bece54ef69131fba427dd57d55c232d3bb5fdb62ac41aa8354.css integrity="sha256-phzbKXnzwr7OVO9pEx+6Qn3VfVXCMtO7X9tirEGqg1Q=" crossorigin=anonymous><script defer src=/tech-book/fuse.min.js></script><script defer src=/tech-book/en.search.min.280f77605f1f02419dcfb6f569488c4025c08f95b37a468739abe24e69d2b6f2.js integrity="sha256-KA93YF8fAkGdz7b1aUiMQCXAj5WzekaHOaviTmnStvI=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/tech-book/><img src=/tech-book/logo.png alt=Logo><span>Technical Book</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><input type=checkbox id=section-99f552133860bc21797a47fe73e93434 class=toggle>
<label for=section-99f552133860bc21797a47fe73e93434 class="flex justify-between"><a href=/tech-book/docs/5g/>5G</a></label><ul><li><input type=checkbox id=section-dfc790b73acb0410a0114547cbf5af32 class=toggle>
<label for=section-dfc790b73acb0410a0114547cbf5af32 class="flex justify-between"><a href=/tech-book/docs/5g/5g-intro/>An Overview of 5G Networking</a></label></li></ul></li><li><input type=checkbox id=section-7c4a3b16aeeb5b7194b232c1eef2f4fb class=toggle>
<label for=section-7c4a3b16aeeb5b7194b232c1eef2f4fb class="flex justify-between"><a href=/tech-book/docs/algorithms/>Algorithms</a></label><ul><li><input type=checkbox id=section-8956d82fbe6869140758f7e8679174bc class=toggle>
<label for=section-8956d82fbe6869140758f7e8679174bc class="flex justify-between"><a href=/tech-book/docs/algorithms/breadth-first-search/>Breadth First Search</a></label></li><li><input type=checkbox id=section-5a049cfad1740f3fd30565524385fa57 class=toggle>
<label for=section-5a049cfad1740f3fd30565524385fa57 class="flex justify-between"><a href=/tech-book/docs/algorithms/depth-first-search/>Depth First Search</a></label></li><li><input type=checkbox id=section-ebc049f26d82165be8c6f1f9e504e799 class=toggle>
<label for=section-ebc049f26d82165be8c6f1f9e504e799 class="flex justify-between"><a href=/tech-book/docs/algorithms/easy/>Easy Complexity</a></label></li><li><input type=checkbox id=section-1071946392bd1f431993e950147fa054 class=toggle>
<label for=section-1071946392bd1f431993e950147fa054 class="flex justify-between"><a href=/tech-book/docs/algorithms/priority-queue-and-heap/>Priority Queue and Heap</a></label></li><li><input type=checkbox id=section-08afbeb294c43ca4908c1c89a4be9d0a class=toggle>
<label for=section-08afbeb294c43ca4908c1c89a4be9d0a class="flex justify-between"><a href=/tech-book/docs/algorithms/two-pointers/>Two Pointers & Sliding Window</a></label></li><li><input type=checkbox id=section-ef36c7c4f7e0dec6525068c3c409100c class=toggle>
<label for=section-ef36c7c4f7e0dec6525068c3c409100c class="flex justify-between"><a href=/tech-book/docs/algorithms/medium/>Medium Complexity</a></label></li></ul></li><li><input type=checkbox id=section-8c7c5c4a8382299873178820b1d91be1 class=toggle>
<label for=section-8c7c5c4a8382299873178820b1d91be1 class="flex justify-between"><a href=/tech-book/docs/ai-ml-dc/>Data Center Networking for AI Clusters</a></label><ul><li><input type=checkbox id=section-433ccede4154db01f6c601940d2949e0 class=toggle>
<label for=section-433ccede4154db01f6c601940d2949e0 class="flex justify-between"><a href=/tech-book/docs/ai-ml-dc/1-ai-ml-networking/>AI/ML Networking</a></label></li><li><input type=checkbox id=section-65f71f2455a94ea3d1143666d556b0ed class=toggle>
<label for=section-65f71f2455a94ea3d1143666d556b0ed class="flex justify-between"><a href=/tech-book/docs/ai-ml-dc/2-ai-deep-learning-basics/>Deep Learning Basics | Artificial Neuron</a></label></li><li><input type=checkbox id=section-af7b72510cdccfb9feb048bbf70c6f27 class=toggle>
<label for=section-af7b72510cdccfb9feb048bbf70c6f27 class="flex justify-between"><a href=/tech-book/docs/ai-ml-dc/2-1-large-language-models/>Large Language Models (LLM)</a></label></li><li><input type=checkbox id=section-b3eb6a6d3a1b87cba26dcfbb99658303 class=toggle>
<label for=section-b3eb6a6d3a1b87cba26dcfbb99658303 class="flex justify-between"><a href=/tech-book/docs/ai-ml-dc/2-2-parallelism-strategies-in-deep-learning/>Parallelism Strategies in Deep Learning</a></label></li><li><input type=checkbox id=section-f11d3aa2e337730e1e3345f8530fe134 class=toggle>
<label for=section-f11d3aa2e337730e1e3345f8530fe134 class="flex justify-between"><a href=/tech-book/docs/ai-ml-dc/3-challenges-in-ai-fabric/>Challenges in AI Fabric Design</a></label></li><li><input type=checkbox id=section-e28420ec7507646128f3695b6f9badbb class=toggle>
<label for=section-e28420ec7507646128f3695b6f9badbb class="flex justify-between"><a href=/tech-book/docs/ai-ml-dc/4-congestion-avoidance-in-ai-fabric/>Congestion Avoidance in AI Fabric</a></label></li><li><input type=checkbox id=section-67bb7cbb1dd95e59f8515201219c090f class=toggle>
<label for=section-67bb7cbb1dd95e59f8515201219c090f class="flex justify-between"><a href=/tech-book/docs/ai-ml-dc/5-load-balancing-in-ai-fabric/>Load Balancing in AI Fabric</a></label></li><li><input type=checkbox id=section-5f3e07f6cf7921e5291ff7894e06b19b class=toggle>
<label for=section-5f3e07f6cf7921e5291ff7894e06b19b class="flex justify-between"><a href=/tech-book/docs/ai-ml-dc/6-backend-network-topologies-for-ai-fabric/>Backend Network Topologies for AI Fabrics</a></label></li><li><input type=checkbox id=section-e19a1e9030cc104536fa46dd0bdb082c class=toggle>
<label for=section-e19a1e9030cc104536fa46dd0bdb082c class="flex justify-between"><a href=/tech-book/docs/ai-ml-dc/7-backend-network-in-gpu-fabric/>Backend Network/Rail Designs</a></label></li></ul></li><li><input type=checkbox id=section-3272b2d28b2b247027bf478619ca416f class=toggle>
<label for=section-3272b2d28b2b247027bf478619ca416f class="flex justify-between"><a href=/tech-book/docs/data-center/>Data Center Tips</a></label><ul><li><input type=checkbox id=section-984f932c7aba4f0a1841e8413165c947 class=toggle>
<label for=section-984f932c7aba4f0a1841e8413165c947 class="flex justify-between"><a href=/tech-book/docs/data-center/data-center-ethernet/>Data Center Ethernet</a></label></li><li><input type=checkbox id=section-bc5ac88940153a700e63e3be886c63cc class=toggle>
<label for=section-bc5ac88940153a700e63e3be886c63cc class="flex justify-between"><a href=/tech-book/docs/data-center/data-center-technologies/>Data Center Technologies</a></label></li><li><input type=checkbox id=section-86fde1ddf43700ef8191e11c59a82cf1 class=toggle>
<label for=section-86fde1ddf43700ef8191e11c59a82cf1 class="flex justify-between"><a href=/tech-book/docs/data-center/data-center-network-virtualization/>Network Virtualization in Cloud Data Centers</a></label></li></ul></li><li><input type=checkbox id=section-ddf784688e0c6d5abb681d2c57851559 class=toggle>
<label for=section-ddf784688e0c6d5abb681d2c57851559 class="flex justify-between"><a href=/tech-book/docs/manageability/>Manageability</a></label><ul><li><input type=checkbox id=section-33ac730897af6feca81c1fdb7869c57e class=toggle>
<label for=section-33ac730897af6feca81c1fdb7869c57e class="flex justify-between"><a href=/tech-book/docs/manageability/why-grpc-on-http2/>gRPC on HTTP/2</a></label></li></ul></li><li><input type=checkbox id=section-c14ae944424668ef125e10cd791a3d3d class=toggle>
<label for=section-c14ae944424668ef125e10cd791a3d3d class="flex justify-between"><a href=/tech-book/docs/networking-tips/>Networking Tips</a></label><ul><li><input type=checkbox id=section-78fdf21c03c55935d3146441b06faf3e class=toggle>
<label for=section-78fdf21c03c55935d3146441b06faf3e class="flex justify-between"><a href=/tech-book/docs/networking-tips/dns/>DNS Overview</a></label></li><li><input type=checkbox id=section-bbcb027a658dc7a2333d59078ee507f9 class=toggle>
<label for=section-bbcb027a658dc7a2333d59078ee507f9 class="flex justify-between"><a href=/tech-book/docs/networking-tips/ecmp/>ECMP Load Balancing</a></label></li><li><input type=checkbox id=section-3b39b86f18b3451e5b8a1b81c369549c class=toggle>
<label for=section-3b39b86f18b3451e5b8a1b81c369549c class="flex justify-between"><a href=/tech-book/docs/networking-tips/ip-fragmentation/>IP Fragmentation - IPv4 & IPv6</a></label></li><li><input type=checkbox id=section-c6d06c54cc91b0bc3f948d33b437fa8b class=toggle>
<label for=section-c6d06c54cc91b0bc3f948d33b437fa8b class="flex justify-between"><a href=/tech-book/docs/networking-tips/ip-tos-dscp/>IP Precedence And TOS | DSCP</a></label></li><li><input type=checkbox id=section-5f3260c76dd37177e3f89057bfe520ae class=toggle>
<label for=section-5f3260c76dd37177e3f89057bfe520ae class="flex justify-between"><a href=/tech-book/docs/networking-tips/traceroute/>Linux traceroute tool</a></label></li><li><input type=checkbox id=section-a26cc3fafb36cbc55527adf39ec83849 class=toggle>
<label for=section-a26cc3fafb36cbc55527adf39ec83849 class="flex justify-between"><a href=/tech-book/docs/networking-tips/mlag/>Multi Chassis Link Aggregation Basics</a></label></li><li><input type=checkbox id=section-36409a0abcb2d4d4baf2e0b682d1a5dd class=toggle>
<label for=section-36409a0abcb2d4d4baf2e0b682d1a5dd class="flex justify-between"><a href=/tech-book/docs/networking-tips/qos/>QoS</a></label></li><li><input type=checkbox id=section-db41e3547d316b01acf9a0ce9c04ef34 class=toggle>
<label for=section-db41e3547d316b01acf9a0ce9c04ef34 class="flex justify-between"><a href=/tech-book/docs/networking-tips/spine-leaf-arch/>Spine-leaf Architecture Basics</a></label></li><li><input type=checkbox id=section-0eb0d409074a76b8cb02624655e2434d class=toggle>
<label for=section-0eb0d409074a76b8cb02624655e2434d class="flex justify-between"><a href=/tech-book/docs/networking-tips/tcp-congestion/>TCP Congestion Control</a></label></li><li><input type=checkbox id=section-3d1710947b3c5be1a1cc33d88fcc6f54 class=toggle>
<label for=section-3d1710947b3c5be1a1cc33d88fcc6f54 class="flex justify-between"><a href=/tech-book/docs/networking-tips/tcp-data-transfer/>TCP Data Transfer</a></label></li></ul></li><li><input type=checkbox id=section-f0a392f2f083f28a4991336773716a63 class=toggle>
<label for=section-f0a392f2f083f28a4991336773716a63 class="flex justify-between"><a href=/tech-book/docs/optical-knowledge/>Optical Knowledge</a></label><ul><li><input type=checkbox id=section-18261b95a92d4fa86116243edca4e9fb class=toggle>
<label for=section-18261b95a92d4fa86116243edca4e9fb class="flex justify-between"><a href=/tech-book/docs/optical-knowledge/optical-breakout/>Optical Transceiver(Grey) & Breakout Model</a></label></li></ul></li><li><input type=checkbox id=section-a55840d746138b3d1fedb81acbccdded class=toggle>
<label for=section-a55840d746138b3d1fedb81acbccdded class="flex justify-between"><a href=/tech-book/docs/programming-tips/>Programming Tips</a></label><ul><li><input type=checkbox id=section-f929f1fe13cb5d6cc96ca3e98f9d9777 class=toggle>
<label for=section-f929f1fe13cb5d6cc96ca3e98f9d9777 class="flex justify-between"><a href=/tech-book/docs/programming-tips/c++/>C++ Tips</a></label></li></ul></li><li><input type=checkbox id=section-b35dbf5ebcd4c19926cf5a9aab6c7655 class=toggle checked>
<label for=section-b35dbf5ebcd4c19926cf5a9aab6c7655 class="flex justify-between"><a href=/tech-book/docs/systemdesign-tips/>SystemDesign-Tips</a></label><ul><li><input type=checkbox id=section-4a618bc3b0b30107f0cec6d3bd6c025f class=toggle>
<label for=section-4a618bc3b0b30107f0cec6d3bd6c025f class="flex justify-between"><a href=/tech-book/docs/systemdesign-tips/code-deployment-system/>Design A Code-Deployment System</a></label></li><li><input type=checkbox id=section-e600754306aa95ce9c5a72b5efec6d7a class=toggle checked>
<label for=section-e600754306aa95ce9c5a72b5efec6d7a class="flex justify-between"><a href=/tech-book/docs/systemdesign-tips/stock-broker/ class=active>Design A Stock-Broker System</a></label></li><li><input type=checkbox id=section-bfa7a29878f65cfbb179e491c1211fa8 class=toggle>
<label for=section-bfa7a29878f65cfbb179e491c1211fa8 class="flex justify-between"><a href=/tech-book/docs/systemdesign-tips/design-amazon/>Design Amazon</a></label></li><li><input type=checkbox id=section-5456837e25872f6352d861a9b5662cb1 class=toggle>
<label for=section-5456837e25872f6352d861a9b5662cb1 class="flex justify-between"><a href=/tech-book/docs/systemdesign-tips/design-slack/>Design Slack</a></label></li><li><input type=checkbox id=section-5a78d16f54536a400b654f17f917bce1 class=toggle>
<label for=section-5a78d16f54536a400b654f17f917bce1 class="flex justify-between"><a href=/tech-book/docs/systemdesign-tips/google-drive/>Google Drive - Design</a></label></li></ul></li></ul><ul><li><a href=/tech-book/posts/>Blog</a></li><li><a href=https://prasenjitmanna.com/ target=_blank rel=noopener>Prasenjit's Blog</a></li><li><a href=https://prasenjitmanna.com/tech-book/ target=_blank rel=noopener>Prasenjit - Tech Book</a></li><li><a href=https://prasenjitmanna.com/upskills/ target=_blank rel=noopener>Prasenjit - Upskills</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/tech-book/svg/menu.svg class=book-icon alt=Menu>
</label><strong>Design A Stock-Broker System</strong>
<label for=toc-control><img src=/tech-book/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#1-gathering-system-requirements>1. Gathering System Requirements</a></li><li><a href=#2-coming-up-with-a-plan>2. Coming Up With A Plan</a></li><li><a href=#3-api-call>3. API Call</a></li><li><a href=#4-api-servers>4. API Server(s)</a></li><li><a href=#5-trade-execution-queue>5. Trade-Execution Queue</a></li><li><a href=#6-trade-execution-logic>6. Trade-Execution Logic</a></li><li><a href=#7-exchange-callback>7. Exchange Callback</a></li><li><a href=#8-system-diagram>8. System Diagram</a></li></ul></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h3 id=1-gathering-system-requirements>1. Gathering System Requirements
<a class=anchor href=#1-gathering-system-requirements>#</a></h3><p>As with any systems design interview question, the first thing that we want to do is to gather system requirements; we need to figure out what system we&rsquo;re building exactly.</p><p>We&rsquo;re building a stock-brokerage platform like Robinhood that functions as the intermediary between end-customers and some central stock exchange. The idea is that the central stock exchange is the platform that actually executes stock trades, whereas the stockbroker is just the platform that customers talk to when they want to place a trade&ndash;the stock brokerage is &ldquo;simpler&rdquo; and more &ldquo;human-readable&rdquo;, so to speak.</p><p>We only care about supporting market trades&ndash;trades that are executed at the current stock price&ndash;and we can assume that our system stores customer balances (i.e., funds that customers may have previously deposited) in a SQL table.</p><p>We need to design a <em>PlaceTrade</em> API call, and we know that the central exchange&rsquo;s equivalent API method will take in a callback that&rsquo;s guaranteed to be executed upon completion of a call to that API method.</p><p>We&rsquo;re designing this system to support millions of trades per day coming from millions of customers in a single region (the U.S., for example). We want the system to be highly available.</p><h3 id=2-coming-up-with-a-plan>2. Coming Up With A Plan
<a class=anchor href=#2-coming-up-with-a-plan>#</a></h3><p>It&rsquo;s important to organize ourselves and to lay out a clear plan regarding how we&rsquo;re going to tackle our design. What are the major, distinguishable components of our how system?</p><p>We&rsquo;ll approach the design front to back:</p><ul><li>the <em>PlaceTrade</em> API call that clients will make</li><li>the API server(s) handling client API calls</li><li>the system in charge of executing orders for each customer</li></ul><p>We&rsquo;ll need to make sure that the following hold:</p><ul><li>trades can never be stuck forever without either succeeding or failing to be executed</li><li>a single customer&rsquo;s trades have to be executed in the order in which they were placed</li><li>balances can never go in the negatives</li></ul><h3 id=3-api-call>3. API Call
<a class=anchor href=#3-api-call>#</a></h3><p>The core API call that we have to implement is <em>PlaceTrade</em>.</p><p>We&rsquo;ll define its signature as:</p><pre tabindex=0><code>PlaceTrade(
  customerId: string,
  stockTicker: string,
  type: string (BUY/SELL),
  quantity: integer,
) =&gt; (
  tradeId: string,
  stockTicker: string,
  type: string (BUY/SELL),
  quantity: integer,
  createdAt: timestamp,
  status: string (PLACED),
  reason: string,
)
</code></pre><p>The customer ID can be derived from an authentication token that&rsquo;s only known to the user and that&rsquo;s passed into the API call.</p><p>The status can be one of:</p><ul><li><strong>PLACED</strong></li><li><strong>IN PROGRESS</strong></li><li><strong>FILLED</strong></li><li><strong>REJECTED</strong></li></ul><p>That being said, <strong>PLACED</strong> will actually be the defacto status here, because the other statuses will be asynchronously set once the exchange executes our callback. In other words, the trade status will always be <strong>PLACED</strong> when the <em>PlaceTrade</em> API call returns, but we can imagine that a <em>GetTrade</em> API call could return statuses other than <strong>PLACED</strong>.</p><p>Potential reasons for a <strong>REJECTED</strong> trade might be:</p><ul><li><p>insufficient funds</p></li><li><p>random error</p></li><li><p>past market hours</p></li></ul><h3 id=4-api-servers>4. API Server(s)
<a class=anchor href=#4-api-servers>#</a></h3><p>We&rsquo;ll need multiple API servers to handle all of the incoming requests. Since we don&rsquo;t need any caching when making trades, we don&rsquo;t need any server stickiness, and we can just use some <strong>round-robin load balancing</strong> to distribute incoming requests between our API servers.</p><p>Once API servers receive a <em>PlaceTrade</em> call, they&rsquo;ll store the trade in a SQL table. This table needs to be in the same SQL database as the one that the balances table is in, because we&rsquo;ll need to use ACID transactions to alter both tables in an atomic way.</p><p>The SQL table for trades will look like this:</p><ul><li>id: <em>string</em>, a random, auto-generated string</li><li>customer_id: <em>string</em>, the id of the customer making the trade</li><li>stockTicker: <em>string</em>, the ticker symbol of the stock being traded</li><li>type: <em>string</em>, either <strong>BUY</strong> or <strong>SELL</strong></li><li>quantity: <em>integer</em> (no fractional shares), the number of shares to trade</li><li>status: <em>string</em>, the status of the trade; starts as <strong>PLACED</strong></li><li>created_at: <em>timestamp</em>, the time when the trade was created</li><li>reason: <em>string</em>, the human-readable justification of the trade&rsquo;s status</li></ul><p>The SQL table for balances will look like this:</p><ul><li>id: <em>string</em>, a random, auto-generated string</li><li>customer_id: <em>string</em>, the id of the customer related to the balance</li><li>amount: <em>float</em>, the amount of money that the customer has in USD</li><li>last_modified: <em>timestamp</em>, the time when the balance was last modified</li></ul><h3 id=5-trade-execution-queue>5. Trade-Execution Queue
<a class=anchor href=#5-trade-execution-queue>#</a></h3><p>With hundreds of orders placed every second, the trades table will be pretty massive. We&rsquo;ll need to figure out a robust way to actually execute our trades and to update our table, all the while making sure of a couple of things:</p><ul><li>We want to make sure that for a single customer, we only process a single <strong>BUY</strong> trade at any time, because we need to prevent the customer&rsquo;s balance from ever reaching negative values.</li><li>Given the nature of market orders, we never know the exact dollar value that a trade will get executed at in the exchange until we get a response from the exchange, so we have to speak to the exchange in order to know whether the trade can go through.</li></ul><p>We can design this part of our system with a Publish/Subscribe pattern. The idea is to use a message queue like Apache Kafka or Google Cloud Pub/Sub and to have a set of topics that customer ids map to. This gives us at-least-once delivery semantics to make sure that we don&rsquo;t miss new trades. When a customer makes a trade, the API server writes a row to the database and also creates a message that gets routed to a topic for that customer (using hashing), notifying the topic&rsquo;s subscriber that there&rsquo;s a new trade.</p><p>This gives us a guarantee that for a single customer, we only have a single thread trying to execute their trades at any time.</p><p>Subscribers of topics can be rings of 3 workers (clusters of servers, essentially) that use leader election to have 1 master worker do the work for the cluster (this is for our system&rsquo;s high availability)&ndash;the leader grabs messages as they get pushed to the topic and executes the trades for the customers contained in the messages by calling the exchange. As mentioned above, a single customer&rsquo;s trades are only ever handled by the same cluster of workers, which makes our logic and our SQL queries cleaner.</p><p>As far as how many topics and clusters of workers we&rsquo;ll need, we can do some rough estimation. If we plan to execute millions of trades per day, that comes down to about 10-100 trades per second given open trading hours during a third of a day and non-uniform trading patterns. If we assume that the core execution logic lasts about a second, then we should have roughly 10-100 topics and clusters of workers to process trades in parallel.</p><pre tabindex=0><code>~100,000 seconds per day (3600 * 24)
~1,000,000 trades per day
trades bunched in 1/3rd of the day
--&gt; (1,000,000 / 100,000) * 3 = ~30 trades per second
</code></pre><h3 id=6-trade-execution-logic>6. Trade-Execution Logic
<a class=anchor href=#6-trade-execution-logic>#</a></h3><p>The subscribers (our workers) are streaming / waiting for messages. Imagine the following message were to arrive in the topic queue:</p><pre tabindex=0><code>{&#34;customerId&#34;: &#34;c1&#34;}
</code></pre><p>The following would be pseudo-code for the worker logic:</p><pre tabindex=0><code>// We get the oldest trade that isn&#39;t in a terminal state.
trade = SELECT * FROM trades WHERE
    customer_id = &#39;c1&#39; AND
    (status = &#39;PLACED&#39; OR status = &#39;IN PROGRESS&#39;)
    ORDER BY created_at ASC LIMIT 1;

// If the trade is PLACED, we know that it&#39;s effectively
// ready to be executed. We set it as IN PROGRESS.
if trade.status == &#34;PLACED&#34; {
    UPDATE trades SET status = &#39;IN PROGRESS&#39; WHERE id = trade.id;
}

// In the event that the trade somehow already exists in the
// exchange, the callback will do the work for us.
if exchange.TradeExists(trade.id) {
    return;
}

// We get the balance for the customer.
balance = SELECT amount FROM balances WHERE
    customer_id = &#39;c1&#39;;

// This is the callback that the exchange will execute once
// the trade actually completes. We&#39;ll define it further down
// in the walkthrough.
callback = ...

exchange.Execute(
    trade.stockTicker,
    trade.type,
    trade.quantity,
    max_price = balance,
    callback,
)
</code></pre><h3 id=7-exchange-callback>7. Exchange Callback
<a class=anchor href=#7-exchange-callback>#</a></h3><p>Below is some pseudo code for the exchange callback:</p><pre tabindex=0><code>function exchange_callback(exchange_trade) {
    if exchange_trade.status == &#39;FILLED&#39; {
        BEGIN TRANSACTION;
        trade = SELECT * FROM trades WHERE id = database_trade.id;
        if trade.status &lt;&gt; &#39;IN PROGRESS&#39; {
            ROLLBACK;
            pubsub.send({customer_id: database_trade.customer_id});
            return;
        }
        UPDATE balances SET amount -= exchange_trade.amount WHERE customer_id = database_trade.customer_id;
        UPDATE trades SET status = &#39;FILLED&#39; WHERE id = database_trade.id;
        COMMIT;
    } else if exchange_trade.status == &#39;REJECTED&#39; {
        BEGIN TRANSACTION;
        UPDATE trades SET status = &#39;REJECTED&#39; WHERE id = database_trade.id;
        UPDATE trades SET reason = exchange_trade.reason WHERE id = database_trade.id;
        COMMIT;
    }
    pubsub.send({customer_id: database_trade.customer_id});
    return http.status(200);
}
</code></pre><h3 id=8-system-diagram>8. System Diagram
<a class=anchor href=#8-system-diagram>#</a></h3><p>Final Systems Architecture</p><p><img src=https://prasenjitmanna.com/tech-book/diagrams/stockbroker-system-diagram.svg alt=img|320x271></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/prmanna/tech-book/commit/93fc5c9a902789ade2b7529324156dd666d64a45 title='Last modified by Prasenjit Manna | May 15, 2025' target=_blank rel=noopener><img src=/tech-book/svg/calendar.svg class=book-icon alt>
<span>May 15, 2025</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#1-gathering-system-requirements>1. Gathering System Requirements</a></li><li><a href=#2-coming-up-with-a-plan>2. Coming Up With A Plan</a></li><li><a href=#3-api-call>3. API Call</a></li><li><a href=#4-api-servers>4. API Server(s)</a></li><li><a href=#5-trade-execution-queue>5. Trade-Execution Queue</a></li><li><a href=#6-trade-execution-logic>6. Trade-Execution Logic</a></li><li><a href=#7-exchange-callback>7. Exchange Callback</a></li><li><a href=#8-system-diagram>8. System Diagram</a></li></ul></li></ul></li></ul></nav></div></aside></main></body></html>